---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  warning = FALSE,
  error = FALSE,
  message = FALSE
)
```

# covidtwitterbot

<!-- badges: start -->
<!-- badges: end -->

The goal of covidtwitterbot is to generate the figures and maps that are posted on my twitter bot, @covid_coulsim.  

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("SimonCoulombe/covidtwitterbot")
```

Pour les utilisateurs linux, vous aurez probablement besoin d'installer des librairies tels que 
`
geos-devel  
sqlite3-devel  
proj-devel  
gdal-devel  
libopenssl-devel
`

## Example  


### Tables   
Here are the tables you can fetch and the graphics you can generate..  They are generated from the most up-to-date data.

```{r example}
library(covidtwitterbot)

```


#### load_inspq_covid19_hist()  

The `load_inspq_covid19_hist()` function fetches historical data for Quebec by age, health region and gender.   This includes the numbers of cases ("cas_*"), of deaths ("dec_*") of hospitalizations ("hos_*") and persons tested ("psi_*").   


**dictionnaire (partiel)des données: **

cas_cum_tot_n = nombre de cas confirmés (cumulatifs) selon date de déclaration
cas_cum_lab_n = nombre de cas confirmés en laboratoire (cumulatif) selon date de déclaration
cas_cum_epi_n = nombre de cas confirmés par lien épidémiologique (cumulatif) selon date de déclaration
cas_quo_tot_n = nombre de cas confirmés (quotidien) selon date de déclaration
cas_quo_lab_n = nombre de cas confirmés en laboratoire (quotidien) selon date de déclaration
cas_quo_epi_n = nombre de cas confirmés par lien épidémiologique (quotidien) selon date de déclaration


act_cum_tot_n = nombre de cas actifs  (aujourd'hui)

ret_cum_tot_n = nombre de cas rétablis (cumulatifs
ret_quo_tot_n = nombre de cas rétablis (quotidien)

dec_cum_tot_n = total des décès (cumulatif)
dec_cum_chs_n = total des décès en CHSLD (cumulatif)
dec_cum_rpa_n = total des décès en RPA (cumulatif)
dec_cum_dom_n = total des décès à domicile et inconnu (cumulatif)
dec_cum_aut_n = total des décès en RI et autre (cumulatif)

 
dec_quo_tot_n = total des décès (quotidien)
dec_quo_chs_n = total des décès en CHSLD (quotidien)
dec_quo_rpa_n = total des décès en RPA (quotidien)
dec_quo_dom_n = total des décès à domicile et inconnu (quotidien)
dec_quo_aut_n = total des décès en RI et autre (quotidien)

 
hos_quo_tot_n = nouvelles hospitalisations (régulières + soins intensifs)
hos_quo_reg_n = nouvelles hospitalisations hors soins intensifs
hos_quo_si_n = nouvelles hospitalisations aux soins intensifs

psi_cum_test_pos = cas confirmés cumulatif 
psi_cum_test_inf = personnes infirmées (test négatifs) cumulatif
psi_cum_test_n = cumul de personnes testées cumulatif

psi_quo_test_pos = cas confirmés quotidien   ## cet colonne  est vide pour la dernière journée
psi_quo_test_inf = personnes infirmées (test négatifs) quotidien  ## cet colonne  est vide pour la dernière journée
psi_quo_test_n = cumul de personnes testées quotidien  ## cet colonne  est vide pour la dernière journée




```{r load_inspq_covid19_hist}
load_inspq_covid19_hist() %>% tail(20)
```

#  load_inspq_manual_data()  



The load_inspq_manual_data() function returns the historical number of hospitalisation (hospits_ancien and hospits), intensive care (si) and number of tests (volumetrie) for the province

*dictionnaire des données *  
hospits = hospitalisation hors intensif en cours  
hospits_ancien = hospitalisation hors intensif  en cours (ancienne mesure, remplacée au printemps 2020 par l'actuelle)   
si = soins intensifs en cours  
volumetrie = nombre de tests   (cette colonne est vide pour la dernière journée)



```{r load_inspq_manual_data}
load_inspq_manual_data() %>% tail(20)
```
The get_clean_rls_data() function returns the historical number of cases at the RLS (région locale de service).  There are no historical files at the RLS level on the INSPQ website. This function depends on a bunch of historical data that I collected, plus a daily archive repository maintained by Jean-Paul R Soucy.

This function takes a while because it has to download a few hundred of CSVs before aggregating them.  
```{r}
rls_data <- get_clean_rls_data() 

rls_data %>% tail(20)
```

We estimate number of cases at the school board (centre de service scolaire) level based on the more fine-grained RLS data. It is not perfect (sometime a RLS stradles 2 CSS so we have to split the cases proportionally to the population in the intersections), but it's a good start.  The get_css_last_week() functions runs faster if you provide it with the `rls_data` object we created when we downloaded the RLS data. If this is not provided then the RLS data has to be downloaded again.



```{r}
css_last_week  <- get_css_last_week(rls_data)
```


### Figures and maps


```{r,fig.height = 9, fig.width = 12}
graph_deces_hospit_tests()
```


```{r,fig.height = 9, fig.width = 12}
graph_quebec_cas_par_region()
```



```{r,fig.height = 9, fig.width = 12}
graph_quebec_cas_par_age()
```




```{r,fig.height = 6, fig.width = 16}
graph_quebec_cas_par_age_heatmap()
```
graph_quebec_cas_par_rls_heatmap() generates the heatmap showing the history of cases per capita.  It runs faster if you provide it with an already-downloaded "rls_data"  dataframe provided by  get_clean_rls_data() 

```{r,fig.height = 22, fig.width = 16}
graph_quebec_cas_par_rls_heatmap(rls_data)
```
`carte_rls()` crée une carte montrant le nombre moyen de cas par jour par million d'habitant durant les 7 derniers jours
```{r,fig.height = 10, fig.width = 12}
carte_rls(rls_data)
```



```{r,fig.height = 10, fig.width = 12}
carte_rls_zoom_montreal(rls_data)
```

We can also generate some charts from the estimated cases by CSS for the previous week: 
```{r,fig.height = 14, fig.width = 14}
carte_css(css_last_week)
```
  
```{r,fig.height = 14, fig.width = 14}
graph_css_bars(css_last_week)
```
  
  
### Shapefiles  

Some shapefiles are included with this package.  They are created using script located in the `data-raw` folder in the repo.  


`shp_water` is a (simplified) shapefile showing all coastal water in a single multipolygon.  It is used when I want to remove water from other shapefiles (such as RLS or CSS).  It is derived from statistics canada's "Coastal waters (polygons)"  for Census 2011 at https://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/bound-limit-2011-eng.cfm . I tried the 2016 version, but some polygons are broken.
```{r}
plot(shp_water[,1])
```


The shapefile `shp_rls`  shows all the RLS in Quebec after removing water.  It is derived from "Limites territoriales des réseaux locaux de santé (RLS) en 2020"  (https://www.donneesquebec.ca/recherche/fr/dataset/limites-territoriales/resource/a73c9996-010d-41ac-a4ba-4def322d55bf),from which I removed the coastal waters.

```{r}
plot(shp_rls[,1])
```
The shapefile `shp_css`  shows all the CSS (centres de services scolaires) in Quebec after removing water.  It is derived from "Centres de services scolaires francophones (SDA)" shapefile https://www.donneesquebec.ca/recherche/dataset/territoires-des-commissions-scolaires-du-quebec/resource/4cd70cc8-2663-4f10-bfce-bb46f62a77da,from which I removed the coastal waters.
```{r}
plot(shp_css[,1])
```

### Palettes  

palette_OkabeIto is a color palette that was built by higher beings to be visible to color-blind people
```{r}
palette_OkabeIto
```

